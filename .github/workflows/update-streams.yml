name: Update Live Streams

on:
  schedule:
    # Run every 5 minutes (more reliable than 3 on GitHub)
    - cron: '*/5 * * * *'
  workflow_dispatch: # Allow manual triggering

permissions:
  contents: write  # Allow workflow to commit and push changes

jobs:
  update-streams:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install requests
        run: pip install requests
      
      - name: Check live streams
        env:
          TWITCH_CLIENT_ID: ${{ secrets.TWITCH_CLIENT_ID }}
          TWITCH_CLIENT_SECRET: ${{ secrets.TWITCH_CLIENT_SECRET }}
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          python << 'EOF'
          import requests
          import json
          import os

          # Get credentials from environment
          CLIENT_ID = os.environ.get('TWITCH_CLIENT_ID')
          CLIENT_SECRET = os.environ.get('TWITCH_CLIENT_SECRET')
          DISCORD_WEBHOOK = os.environ.get('DISCORD_WEBHOOK', '')

          # Get OAuth token
          token_response = requests.post(
              'https://id.twitch.tv/oauth2/token',
              data={
                  'client_id': CLIENT_ID,
                  'client_secret': CLIENT_SECRET,
                  'grant_type': 'client_credentials'
              }
          )
          access_token = token_response.json()['access_token']

          # Load streamers list
          with open('streamers.json', 'r') as f:
              streamers = json.load(f)

          # Check who's live (can query up to 100 at once)
          query_params = '&'.join([f'user_login={s}' for s in streamers])
          
          response = requests.get(
              f'https://api.twitch.tv/helix/streams?{query_params}',
              headers={
                  'Client-ID': CLIENT_ID,
                  'Authorization': f'Bearer {access_token}'
              }
          )

          live_streams = response.json()['data']

          # Get user IDs from live streams to fetch profile images
          if live_streams:
              user_ids = [stream['user_id'] for stream in live_streams]
              user_query = '&'.join([f'id={uid}' for uid in user_ids])
              
              users_response = requests.get(
                  f'https://api.twitch.tv/helix/users?{user_query}',
                  headers={
                      'Client-ID': CLIENT_ID,
                      'Authorization': f'Bearer {access_token}'
                  }
              )
              
              users_data = users_response.json()['data']
              
              # Create a mapping of user_id to profile_image_url
              profile_images = {user['id']: user['profile_image_url'] for user in users_data}
              
              # Add profile images to stream data
              for stream in live_streams:
                  stream['profile_image_url'] = profile_images.get(stream['user_id'], '')

          # Load previous streams to detect NEW streams
          previous_streams = []
          try:
              with open('live_streams.json', 'r') as f:
                  previous_streams = json.load(f)
          except FileNotFoundError:
              pass

          # Find newly live streams by comparing started_at timestamps
          previous_stream_sessions = {s['user_login']: s['started_at'] for s in previous_streams}
          new_streams = []
          
          for stream in live_streams:
              # Check if this is a NEW stream session (different started_at or not in previous)
              if stream['user_login'] not in previous_stream_sessions or                  previous_stream_sessions[stream['user_login']] != stream['started_at']:
                  new_streams.append(stream)

          # Send Discord notifications for NEW streams only
          if DISCORD_WEBHOOK and new_streams:
              for stream in new_streams:
                  try:
                      embed = {
                          "title": f"{stream['user_name']} is now live!",
                          "url": f"https://www.twitch.tv/{stream['user_login']}",
                          "color": 9520895,  # Twitch purple
                          "author": {
                              "name": stream['user_name'],
                              "icon_url": stream.get('profile_image_url', 'https://static-cdn.jtvnw.net/jtv_user_pictures/default_profile_pic-50x50.png')
                          },
                          "description": stream.get('title', 'Come watch the stream!'),
                          "thumbnail": {
                              "url": stream.get('profile_image_url', 'https://static-cdn.jtvnw.net/jtv_user_pictures/default_profile_pic-300x300.png')
                          },
                          "fields": [
                              {
                                  "name": "ðŸŽ® Game",
                                  "value": stream.get('game_name', 'Not specified'),
                                  "inline": True
                              },
                              {
                                  "name": "ðŸ‘¥ Viewers",
                                  "value": str(stream.get('viewer_count', 0)),
                                  "inline": True
                              }
                          ],
                          "timestamp": stream['started_at']
                      }
                      
                      discord_response = requests.post(
                          DISCORD_WEBHOOK,
                          json={"embeds": [embed]},
                          headers={"Content-Type": "application/json"}
                      )
                      
                      if discord_response.status_code == 204:
                          print(f"âœ… Discord notification sent for {stream['user_name']}")
                      else:
                          print(f"âš ï¸ Discord notification failed for {stream['user_name']}: {discord_response.status_code}")
                  except Exception as e:
                      print(f"âš ï¸ Error sending Discord notification for {stream['user_name']}: {e}")

          # Save to file
          with open('live_streams.json', 'w') as f:
              json.dump(live_streams, f, indent=2)

          print(f"Found {len(live_streams)} live stream(s)")
          if new_streams:
              print(f"NEW streams detected: {len(new_streams)}")
              for stream in new_streams:
                  print(f"  - {stream['user_name']}: {stream['viewer_count']} viewers")
          else:
              for stream in live_streams:
                  print(f"  - {stream['user_name']}: {stream['viewer_count']} viewers (already notified)")
          EOF
      
      - name: Commit and push if changed
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add live_streams.json
          git diff --quiet && git diff --staged --quiet || (git commit -m "Update live streams [skip ci]" && git push)
