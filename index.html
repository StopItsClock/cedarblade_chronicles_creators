<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cedarblade Chronicles - Live Streams</title>
    <script src="https://embed.twitch.tv/embed/v1.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Trebuchet MS', 'Lucida Sans', Arial, sans-serif;
            background: linear-gradient(135deg, #1a0f0a 0%, #2c1810 50%, #1a0f0a 100%);
            color: #f0e6d2;
            min-height: 100vh;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 40px;
            padding: 20px;
            background: rgba(61, 40, 23, 0.6);
            border-radius: 15px;
            border: 2px solid #d4af37;
            box-shadow: 0 0 20px rgba(212, 175, 55, 0.3);
        }
        
        .logo {
            max-width: 300px;
            height: auto;
            margin-bottom: 15px;
            filter: drop-shadow(0 0 10px rgba(212, 175, 55, 0.5));
        }
        
        .logo-text {
            color: #d4af37;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.7);
            margin-bottom: 15px;
        }
        
        .subtitle {
            font-size: 1.5em;
            color: #d4af37;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            margin: 10px 0;
        }
        
        .loading {
            text-align: center;
            font-size: 1.2em;
            padding: 40px;
            color: #d4af37;
        }
        
        .spinner {
            border: 4px solid rgba(212, 175, 55, 0.3);
            border-top: 4px solid #d4af37;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .streams-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 25px;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .stream-container {
            background: rgba(61, 40, 23, 0.8);
            border-radius: 12px;
            overflow: hidden;
            border: 2px solid #8b4513;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .stream-container:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(212, 175, 55, 0.4);
        }
        
        .stream-header {
            display: block;
            padding: 15px;
            background: linear-gradient(135deg, #4a7c59 0%, #3d6349 100%);
            color: white;
            text-decoration: none;
            font-weight: bold;
            font-size: 1.1em;
            text-align: center;
            border-bottom: 2px solid #d4af37;
            transition: background 0.3s ease;
        }
        
        .stream-header:hover {
            background: linear-gradient(135deg, #5a8c69 0%, #4d7359 100%);
        }
        
        .stream-info {
            padding: 10px 15px;
            background: rgba(44, 24, 16, 0.9);
            border-top: 1px solid #8b4513;
        }
        
        .stream-title {
            font-size: 0.95em;
            margin-bottom: 5px;
            color: #f0e6d2;
        }
        
        .stream-meta {
            font-size: 0.85em;
            color: #d4af37;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .viewer-count {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .live-badge {
            background: #e74c3c;
            color: white;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            font-weight: bold;
            text-transform: uppercase;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .no-streams {
            text-align: center;
            padding: 60px 20px;
            font-size: 1.3em;
            color: #d4af37;
            background: rgba(61, 40, 23, 0.6);
            border-radius: 15px;
            border: 2px dashed #8b4513;
            max-width: 600px;
            margin: 0 auto;
        }
        
        .no-streams-icon {
            font-size: 3em;
            margin-bottom: 20px;
        }
        
        .footer {
            text-align: center;
            margin-top: 50px;
            padding: 20px;
            color: #a0a0a0;
            font-size: 0.9em;
        }
        
        @media (max-width: 768px) {
            .streams-grid {
                grid-template-columns: 1fr;
            }
            
            .header {
                padding: 15px;
            }
            
            .logo {
                max-width: 200px;
            }
            
            .subtitle {
                font-size: 1.2em;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1 class="logo-text">‚öîÔ∏è Cedarblade Chronicles ‚öîÔ∏è</h1>
        <div class="subtitle">üéÆ Live Streams üéÆ</div>
    </div>
    
    <div id="loading-indicator" class="loading">
        <div class="spinner"></div>
        <div>Loading live streams...</div>
    </div>
    
    <div class="streams-grid" id="streams-grid"></div>
    
    <div id="no-streams-message" class="no-streams" style="display: none;">
        <div class="no-streams-icon">üò¥</div>
        <div>No one is streaming right now</div>
        <div style="margin-top: 15px; font-size: 0.8em; color: #a0a0a0;">
            Check back later for epic adventures!
        </div>
    </div>
    
    <div class="footer">
        Cedarblade Chronicles Stream Manager v2.0 (Secure)<br>
        Updates automatically every 3 minutes via GitHub Actions
    </div>

    <script>
        // DOM elements
        const loadingIndicator = document.getElementById('loading-indicator');
        const streamsGrid = document.getElementById('streams-grid');
        const noStreamsMessage = document.getElementById('no-streams-message');
        
        let embedInstances = new Map();
        
        // Fetch live streams data from JSON file (updated by GitHub Actions)
        async function fetchLiveStreams() {
            try {
                // Add cache-busting parameter to ensure fresh data
                const response = await fetch(`live_streams.json?t=${Date.now()}`);
                
                if (!response.ok) {
                    console.error('Failed to fetch live streams');
                    return [];
                }
                
                const liveStreams = await response.json();
                return liveStreams;
            } catch (error) {
                console.error('Error fetching live streams:', error);
                return [];
            }
        }
        
        // Create embed for a live stream
        function createStreamEmbed(streamData) {
            const container = document.createElement('div');
            container.className = 'stream-container';
            container.id = `stream-${streamData.user_login}`;
            
            const embedDiv = document.createElement('div');
            embedDiv.id = `embed-${streamData.user_login}`;
            
            const header = document.createElement('a');
            header.href = `https://www.twitch.tv/${streamData.user_login}`;
            header.target = '_blank';
            header.className = 'stream-header';
            header.textContent = `${streamData.user_name}'s Stream`;
            
            const info = document.createElement('div');
            info.className = 'stream-info';
            info.innerHTML = `
                <div class="stream-title">${streamData.title}</div>
                <div class="stream-meta">
                    <span class="viewer-count">
                        üë• ${streamData.viewer_count.toLocaleString()} viewers
                    </span>
                    <span class="live-badge">üî¥ Live</span>
                </div>
            `;
            
            container.appendChild(header);
            container.appendChild(embedDiv);
            container.appendChild(info);
            
            // Create Twitch embed
            try {
                const embed = new Twitch.Embed(`embed-${streamData.user_login}`, {
                    width: '100%',
                    height: 264,
                    channel: streamData.user_login,
                    layout: 'video',
                    autoplay: false,
                    muted: true,
                    parent: ['stopitsclock.github.io', 'localhost']
                });
                
                embedInstances.set(streamData.user_login, embed);
            } catch (error) {
                console.error(`Error creating embed for ${streamData.user_login}:`, error);
            }
            
            return container;
        }
        
        // Update the display with live streams
        function updateStreamsDisplay(liveStreams) {
            // Clear existing embeds
            streamsGrid.innerHTML = '';
            embedInstances.clear();
            
            if (liveStreams.length === 0) {
                streamsGrid.style.display = 'none';
                noStreamsMessage.style.display = 'block';
            } else {
                streamsGrid.style.display = 'grid';
                noStreamsMessage.style.display = 'none';
                
                // Sort by viewer count
                liveStreams.sort((a, b) => b.viewer_count - a.viewer_count);
                
                // Create embeds for live streams
                liveStreams.forEach(stream => {
                    const container = createStreamEmbed(stream);
                    streamsGrid.appendChild(container);
                });
            }
            
            loadingIndicator.style.display = 'none';
        }
        
        // Main update function
        async function updatePage() {
            console.log('Fetching live streams data...');
            const liveStreams = await fetchLiveStreams();
            console.log(`Found ${liveStreams.length} live stream(s)`);
            updateStreamsDisplay(liveStreams);
        }
        
        // Initialize
        window.addEventListener('load', async () => {
            // Wait for Twitch embed library
            const waitForTwitch = () => {
                return new Promise((resolve) => {
                    const check = () => {
                        if (typeof Twitch !== 'undefined' && Twitch.Embed) {
                            resolve();
                        } else {
                            setTimeout(check, 100);
                        }
                    };
                    check();
                });
            };
            
            await waitForTwitch();
            
            // Initial update
            await updatePage();
            
            // Refresh page data every 30 seconds (GitHub Actions updates the JSON every 3 minutes)
            setInterval(updatePage, 30000);
        });
    </script>
</body>
</html>